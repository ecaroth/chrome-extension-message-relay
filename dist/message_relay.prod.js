/* Version 2.0.0 chrome-extension-message-relay (https://github.com/ecaroth/chrome-extension-message-relay), Authored by Evan Carothers */

(()=>{"use strict";const e=function(e,n,t){const s=t||!1,i=Object.freeze({extension:"extension",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"}),o=Object.freeze({extension:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1}),a=n;let r={},f=null,l=e,m=null,g=null,c={},d={},u=null;function p(e){let n=e.split(".");return{type:n.splice(0,1)[0],namespace:n.length>0?n.join("."):null}}function _(e,n){if(e in c)for(let t=c[e].length-1;t>=0;t--)c[e][t].ns===n&&c[e].splice(t,1)}function $(e,n,t,s){s||(s={});let i="msg_id"in s?s.msg_id:`${n}:${e}:${(new Date).getTime()}`;s.msg_id=i;let o={msg_type:e,msg_from:a,msg_destination:n,msg_up:t,msg_namespace:l,msg_data:s,msg_id:i,msg_tab_id:null},r=b(n);return r.tab_id&&(o.msg_destination=r.level,o.msg_tab_id=r.tab_id),o}function y(e){!function(e,n){if(e===i.extension)if(n.msg_tab_id)d[n.msg_tab_id]=d[n.msg_tab_id]||[],d[n.msg_tab_id].push(n);else for(var t in d)d[t].push(n);else if(e===i.content&&n.msg_destination===i.extension||e===i.extension)u.postMessage(n);else if(e===i.iframe||e===i.iframe_shim)window.parent.postMessage(n,"*");else if(e!==i.page&&e!==i.content||n.msg_destination!==i.iframe)window.postMessage(n,"*");else{let e=document.getElementsByTagName("iframe");for(let t=0;t<e.length;t++)try{e[t].contentWindow.postMessage(n,"*")}catch(e){}}}(a,e)}function h(e,n){let{msg_data:t,msg_from:s,msg_up:i,msg_destination:f,msg_type:l,msg_id:d}=JSON.parse(JSON.stringify(e));n&&(m=n),g=l;let u=`${d}:${f}`;if(s===a||u in r)return!1;f===a?(v(`Msg (${l}) received from ${s} to ${f} - ${JSON.stringify(t)}`),r[u]=0,function(e,n){if(!(e in c))return;c[e].forEach(e=>{e.fn.call(e,n)})}(l,t)):(e.msg_from=a,i&&o[a]>o[s]?(y(e),v(`Msg (${l}) relaying UP from ${s} to ${f} - ${JSON.stringify(t)}`)):!i&&o[a]<o[s]&&(y(e),v(`Msg (${l}) relaying DOWN ${s} to ${f} - ${JSON.stringify(t)}`)))}function b(e){let n=e.split("@");return{level:n[0],tab_id:n.length>0?parseInt(n[1],10):null}}function v(e){s&&console.log(`::MSG-RELAY (${a}):: ${e}`)}function M(e,n){let t=$(e,a,!0,n);t.msg_from="mock",h(t,{tabId:999})}return f=setInterval(function(){for(let e in r)0===r[e]?r[e]=1:delete r[e]},1e3*120),a!==i.test&&([i.page,i.content,i.iframe,i.iframe_shim].includes(a)&&window.addEventListener("message",function(e){"object"==typeof e.data&&"msg_namespace"in e.data&&e.data.msg_namespace===l&&h(e.data)}),a===i.content&&(v("Alerting extension of ready"),(u=chrome.runtime.connect({name:e})).onMessage.addListener(e=>{h(e)})),a===i.extension&&chrome.runtime.onConnect.addListener(n=>{n.name===e&&function(e){let n=e.sender.tab.id,t=Array.isArray(d[n])?d[n].slice():[];e.onDisconnect.addListener(e=>{delete d[e.sender.tab.id]}),e.onMessage.addListener(n=>{h(n,e.sender)}),d[n]={push:n=>{e.postMessage(n)}},t.forEach(e=>d[n].push(e))}(n)})),{levels:i,on:function(e,n){"string"==typeof e&&(e=[e]),e.forEach(e=>{let t=p(e);t.type in c||(c[t.type]=[]),c[t.type].push({fn:n,ns:t.namespace})})},off:function(e){"string"==typeof e&&(e=[e]),e.forEach(e=>{let n=p(e);n.type in c&&(n.namespace?_(n.type,n.namespace):delete c[n.type])})},offAll:function(e){if(e)for(let n in c)_(n,e);else c={}},send:function(e,n,t){"string"==typeof n&&(n=[n]),n.forEach(n=>{if(!((n=n)&&b(n).level in i))return v(`NOTICE - invalid level specified as destination (${n})`);let s=b(n).level;o[s]<o[a]?function(e,n,t){let s=$(e,n,!1,t);v(`Send msg DOWN from ${a} to ${n} : ${e} - ${JSON.stringify(t)}`),y(s)}(e,n,t):function(e,n,t){let s=$(e,n,!0,t);v(`Send msg UP from ${a} to ${n} : ${e} - ${JSON.stringify(t)}`),y(s)}(e,n,t)});var s},levelViaTabId:function(e,n){return`${e}@${n}`},getLastMsgSenderInfo:()=>m,getLastMsgType:()=>g,mockSend:M,localSend:M}};"undefined"!=typeof module&&module.exports?module.exports=e:window.chrome_extension_message_relay=e})();